---
title: 'カーネルとは？カーネルの役割とCPUの特権レベル'
date: '2025-12-23'
tags: ['低レイヤー', 'OS', 'Linux']
category: 'STUDY_LOG'
---

本記事では、カーネルについてまとめています。

## 事前知識

### ユーザプロセス

アプリケーションのことで、単に「プロセス」と呼ぶこともあります。

ユーザが実行するプログラムはすべてこれに該当します。

## カーネルとは

カーネルとは、OSの中で動いているプログラムで、**OSの中核・本体**ともいえます。

カーネルの存在意義を一言でまとめると、「**ユーザプロセスを健全に動作させること**」です。

カーネルは、ハードウェアを直接操作できる**唯一の特権的なプログラム**です。  
ユーザプロセス（シェルやGUIアプリなど）は、**システムコール**という仕組みを通じてカーネルに処理を依頼することで、ハードウェアの機能を利用します。

### カーネルの役割

カーネルが何をしているのかをシンプルにすると、次の2つに集約されます。

1. **リソース管理**  
    複数のプログラムが同時にメモリやCPUなどのリソースを使うとき、どのプログラムにどう割り当てるのかを管理する役割です。  
    もしカーネルがなければ、プログラム同士がリソースを奪い合い、システム全体が不安定になったり、停止（クラッシュ）したりする原因となります。
2. **抽象化**  
    ハードウェアは、メーカーによって動作の仕組みが違います。  
    カーネルはハードウェアメーカーが作るデバイスドライバを自身に組み込むことで、それぞれのハードウェアの扱い方を覚えます。  
    ハードウェアの電気信号や命令を、デバイスドライバを使いながら解釈し、`read` / `write`などのシステムコールができるファイルの形式に変換し抽象化します。  
    その共通化されたファイルディスクリプタをプログラムに渡すという流れで、どのようなハードウェアともやり取りできるようになります。

抽象化がなければ、プログラマは「A社のHDDに書き込むならこのコード、B社のSSDならこのコード」のように、**メーカーや機器ごとにコードを書き分けなければいけません**。

それぞれの機器のデバイスドライバを束ねて、抽象化してくれるカーネルのおかげで、ハードウェアを気にせずシステムコールを実行するだけで動くようになっています。

## 特権レベル

CPUには**特権レベル**という考え方があります。

特権レベルとは、「そのプログラムをどの権限で実行するか」という権限の話ですが、管理者権限や`su`とは違い、**CPUレベルの権限**です。

中でもよく使われる特権レベルは以下の2つです。

- **ユーザモード**  
    アプリが動く場所で、最弱の権限です。  
    許可されていないメモリ領域へアクセスしようとするとCPUによってブロックされます。  
    これがセグメンテーション違反（segmentation fault）の一例です。
- **カーネルモード**  
    カーネルが動く場所で、強い権限です。  
    全てのハードウェアを操作することができます。

### システムコールのモード切り替え

プログラムで`print()`のような関数を実行すると、その内部で最終的に`write(FD, data)`のようなシステムコールが呼び出され、コンソールに文字が表示されます。

システムコールが呼び出されると、CPUは**ユーザモード**から**カーネルモード**に切り替わります。  
これにより処理の主体がアプリケーションからカーネルへと移り、要求された処理が実行されます。

### x86系CPUの特権レベル

x86系のCPUは、特権レベルを**Ring**と呼ばれる4段階に分けて管理しています。

- Ring 0：カーネルモード
- Ring 3：ユーザモード

Ring 1とRing 2は、歴史的な理由から、現在ではほとんど使用されていません。

### ARMのCPUの特権レベル

ARMのCPUは、特権レベルを「**Exception Level**（EL・例外レベル）」という4段階に分けて管理しています。

- EL0：ユーザモード
- EL1：カーネルモード
- EL2：ハイパーバイザ（複数のOSを動かす時の管理モード）
- EL3：セキュアモニタ（最強権限。指紋認証のデータなど、OSにさえ触らせたくない極秘情報を守る）

ARMの場合は、「イベントが起きた時にどの高さまでレベルを上げるか」という考え方をします。  
つまり、例外を処理するときだけ高いところに上がる動きをベースに設計しており、例外レベルと呼ばれています。

Macでは、EL0とEL1の行き来が1秒間に何回も行われています。  
macOSのカーネルは、XNUカーネルといい、DockerDesktopなどの仮想化ソフトウェアがApple Silicon搭載のMacで非常に高速に動作する理由の一つは、このEL2の処理がハードウェアレベルで効率化されているためです。

### x86とARMの比較

| 役割 | x86 (Ring) | ARM (EL) | 備考 |
| --- | --- | --- | --- |
| アプリ | Ring 3 | EL0 | ユーザモード |
| OSカーネル | Ring 0 | EL1 | カーネルモード |
| ハイパーバイザ | Ring -1 | EL2 | OSをさらに管理する層 |

x86には元々、EL2に相当する公式なRingがなかったため、後付けの仮想化支援機能を俗に「Ring -1（マイナスワン）」と呼んだりします。

ARMは64bit時代に合わせて、過去を捨てて理想の設計を作ろうと再設計しました。  
そのため、**無駄がなくモダンな設計**で低消費電力・仮想化のネイティブ対応・EL1がウイルス感染してもEL3のデータが入ってる領域にはアクセスできないといったセキュリティ機能が備わっています。

対して、x86は**互換性を持たせる**ため、無理やり継ぎ足してきたため、「Ring -1」が存在するような構造になっています。  
その分、古いCPUでも動いたり、新しいPCで古いプログラムを動かせたりします。

## まとめ

今回は、カーネルについてまとめてみました。

カーネルやCPUの仕組みを理解することで、普段使っているコンピュータの挙動をより深く知ることができます。

次回は、今回触れたシステムコールをさらに掘り下げ、ファイルディスクリプタについて解説します。

