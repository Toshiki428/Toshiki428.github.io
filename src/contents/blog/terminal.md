---
title: 'MacのターミナルでNeoVimの色が崩れる？原因はTrue Color非対応でした'
date: '2025-10-27'
tags: ['MacOS', 'ターミナル', 'エラー解決']
category: 'STUDY_LOG'
---

NeoVimに美しいカラースキーム`tokyonight`を導入したのに、なぜか色が正しく表示されない…。  
この記事では、その原因がMac標準の`ターミナル.app`にあったという結論に至るまでの調査プロセスと解決策を解説します。

## 事前知識

はじめに、この先を読む上で必要な知識についてまとめます。

### 1. ターミナルエミュレータ

ターミナルエミュレータとは、テキストベースのインターフェースを提供し、コンピュータを操作するためのソフトウェアのことです。

単に「ターミナル」とも呼びますが、Macには`ターミナル.app`というアプリがあり、混乱を避けるためにここでは「ターミナルエミュレータ」と呼びます。

ターミナルエミュレータを通じて自身のコンピュータや、SSH通信で接続した他のコンピュータを操作できます。

Windowsでは**コマンドプロンプト**や**パワーシェル**、Macでは**ターミナル**や**iTerm2**、Linuxでは**端末**という名前のターミナルエミュレータがよく使われます。

### 2. True Color

True Colorとは、コンピュータが扱う色の表現方法の一つで、約1,677万色を表現できる方式です。

**24ビットカラー**や**フルカラー**とも呼ばれます。

24ビットカラーに透明度を加えた32ビットカラーをTrue Colorと呼ぶこともあるようです。

### 3. エスケープシーケンス

エスケープシーケンスとは、特殊な文字の並びを使って、**ターミナルエミュレータに特別な動作を指示する仕組み**です。  
この仕組みを使うことで、ターミナルの文字色を変えたり、背景色を変えたりできます。

プログラミング言語では、`\n`や`\t`など、**`\`に続けて特定の文字を記述する組み合わせ**をエスケープシーケンスと呼びます。

しかし、ターミナル制御では指しているものが少し違い、`ESC`文字を起点とする特殊な文字の並びを指します。

ターミナル制御に使うエスケープシーケンスの代表的なものに、**ANSIエスケープシーケンス**があります。

### 4. ANSIエスケープシーケンス

ANSIやISOによって規格化・標準化されたエスケープシーケンスです。

ANSIエスケープシーケンスでは、**CSI（Control Sequence Introducer）** という形式が主に使われます。

CSIは、`ESC`文字の直後に`[`が続く形で始まります。  

`ESC`文字は、ASCIIで定義されている制御文字の一つで、`\e`と表現します。  
他にも、`\033`（8進数の`33`）、`\x1B`（16進数の`1B`）と表現できます。

`ESC`文字の直後に`[`が続くことで、ターミナルエミュレータは「CSIの命令だ」と解釈することができます。

命令の終わりは`m`で表します。

言葉だけでは難しいので、実際に文字の色と背景色を変えるANSIエスケープシーケンスを紹介します。

#### 文字色

- `\e[30m`：黒
- `\e[31m`：赤
- `\e[32m`：緑
- `\e[33m`：黄
- `\e[34m`：青
- `\e[35m`：マゼンタ
- `\e[36m`：シアン
- `\e[37m`：白
- `\e[38;5;nm`：`n`に0~255のカラーコードを指定
- `\e[38;2;r;g;bm`：RGBでのカラーコードを指定

#### 背景色

- `\e[40m`：黒
- `\e[41m`：赤
- `\e[42m`：緑
- `\e[43m`：黄
- `\e[44m`：青
- `\e[45m`：マゼンタ
- `\e[46m`：シアン
- `\e[47m`：白
- `\e[48;5;nm`：`n`に0~255のカラーコードを指定
- `\e[48;2;r;g;bm`：RGBでのカラーコードを指定

#### 実験

では、実際にターミナル上で動かしてみましょう。

`RGB`という文字列にそれぞれ色をつけて表示します。

考え方としては、「`\e[31m`（色指定）＋`R`（文字）」の繰り返しです。  
実行するコマンドの全体像は次のようになっています。

```bash
echo -e "\e[31mR\e[32mG\e[34mB"
```

echoコマンドに`-e`オプションをつけると、**エスケープシーケンスを解釈**できるようになります。

結果はこのようになりました。  
この規模を大きくすることで、ターミナル上にVSCodeのような**カラフルなエディタを実装できる**ということです。

![エスケープシーケンス実験結果](/images/blog/terminal-1.png)

### 5. scriptコマンド

`script`コマンドは、ターミナル上の操作をすべて記録するためのコマンドです。

実行すると、`typescript`という名前のファイルが作成され、それ以降のターミナルセッション（入力したコマンドと、その出力結果）がすべてテキストファイルとして保存されます。

一見するとただのテキストですが、中には**画面に表示されないエスケープシーケンスもそのまま記録**されています。  
そのため、「**ターミナルにどんな命令が送られているか**」を後から正確に分析でき、デバッグに非常に役立ちます。

## 状況

前置きが長くなってしまいましたが、ここからが本題です。

これまで、VSCodeを使ってコーディングをしていましたが、「TUIに移行しよう」と思い、NeoVimを使い始めました。  
**TUI（Text User Interface）** 環境は、マウスを使わず**キーボードのみで高速な操作が可能になる**点や、**カスタマイズ性の高さ**から、開発効率の向上が期待できます。

NeoVimの環境を構築する中で、`tokyonight`という**カラースキームプラグイン**を導入しました。

しかし、次の画像のようにきちんと表示されません。  
この状況を解決する中で、試したことや新しく得た知識をまとめています。

![ターミナル.appのNeoVim](/images/blog/terminal-2.png)

## 試したこと

これまでの経験から、エラーの理由がわからない時は**問題箇所の特定**をするべきだと思っています。

今回、問題箇所として考えられるのは、次の3つかと思います。

1. `tokyonight`がおかしい
2. **NeoVim**がおかしい
3. **ターミナルエミュレータ**がおかしい

仮に1であれば、同じように困っている人や、解決策を見つけている人がいそうです。  
ということで検索してみましたが、何も出てこなかったので、この可能性は捨て、2か3かを特定する作業に移ります。

そこで、`script`コマンドでターミナルセッションを記録し、NeoVimが送信する**エスケープシーケンスが正しいか**を確認しました。

ファイルを確認した結果、NeoVimからの指示は正常だと判断でき、問題はターミナルエミュレータ側にあると特定できました。

キャプチャの解析は、記事の最後にまとめています。

## 解決

今回、うまく表示できなかったのは、キャプチャの解析から**ターミナルエミュレータの問題**だとわかりました。

ターミナルエミュレータごとに、対応しているカラーモードが違います。  
4bit color、8bit color、True Colorの3種類があるようです。

問題は、`tokyonight`が**True Colorの環境を求める**のに対し、**Macの`ターミナル.app`がTrue Colorに対応していない**ことです。  
使っているターミナルがTrue Colorに対応しているかを確認するには、次のコマンドを実行します。

```bash
curl -s https://gist.githubusercontent.com/lifepillar/09a44b8cf0f9397465614e622979107f/raw/24-bit-color.sh | bash
```

次の画像の上半分のように、バラバラに表示される場合非対応。  
下半分のように、綺麗なグラデーションが表示される場合対応していることがわかります。

![TrueColor対応確認コマンドの結果](/images/blog/terminal-3.png)

これまでは、`ターミナル.app`を使っていて特に困ることがなかったのですが、NeoVimを使うには`ターミナル.app`では力不足のようです。  
ということで、今回iTerm2をインストールしました。

**iTerm2**は、True Colorに対応しているだけでなく、画面分割やプロファイル機能、豊富なカスタマイズ項目など、多くの便利な機能を備えた人気のターミナルエミュレータです。

設定は何も変更せず、ターミナルエミュレータを変えただけでこのように綺麗に表示できました。

![iTerm2のNeoVim](/images/blog/terminal-4.png)

## 解析

ではここから、NeoVimの指示をキャプチャし、解析してみようと思います。

解析といっても、全部を読むのは大変です。  
今回は、**NeoVimから色を指定するエスケープシーケンスが送られてきているのか**という部分が大切になります。

もし、送られてきていてターミナルが表示できていないなら原因はターミナルエミュレータ、そもそも送られてきていなければ原因はNeoVimという結論になります。

この画像は、キャプチャ結果の一部です。

![キャプチャ結果](/images/blog/terminal-5.png)

抽出するのはどこでもいいのですが、できるだけ短い`exit()`というPythonのコードを表示している部分を確認します。  
`exit`という文字に、`\e[38;2;130;170;255m`と文字色を設定し、`\e[48;2;34;36;54m`と背景色を設定していることが確認できました。

これで、**色を指定する指示があるにも関わらず、それをターミナル側が解釈できなかった**ということがわかります。

では最後に検証してみましょう。  
`A`と赤色で表示したければ、`echo -e "\e[31mA"`ですね。

これは問題なく表示できることを確認して、次に`exit`に設定されていた色を試してみます。

```bash
echo -e "\e[38;2;130;170;255mA"
```

画像の上半分が`ターミナル.app`の結果、下半分がiTerm2の結果です。  
やはり、`ターミナル.app`では色をきちんと表示できていないことが確認できました。

![ターミナル.appとiTerm2の検証比較](images/blog/terminal-6.png)

## まとめ

今回は、NeoVimを使うにあたって遭遇した問題をきっかけに、**ターミナルエミュレータの色をつける仕組み**や**エラー箇所を特定した方法**をまとめました。

はじめは何もわからず難しく感じましたが、やはり調べる中で徐々に理解が進み、「ターミナルエミュレータの表示がおかしい」という現象に対する恐怖感はなくなりました。

今回学んだ、色を付け加える方法などを駆使すれば、ターミナルエミュレータのみで簡単なゲームを作ったりということもできるので、いつかやってみるのも面白そうです。

ちなみに、ブログはこの記事からNeoVimを用いて書いています。  
まだ完全に使いこなせているわけではありませんが、**日に日に操作スピードが上がっていく**のを感じます。

また、TUIの最大のメリットは、どんなOSでもターミナルエミュレータと設定ファイルがあれば同じ環境を再現できる点です。  
もっと使いこなせるようになりたいと感じているので、この調子でNeoVimを極めてみます。

